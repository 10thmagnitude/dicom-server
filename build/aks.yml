# DESCRIPTION:
# Builds, tests and packages the solution for the CI build configuration.
name: $(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:-r)

variables:
- template: aks-variables.yml
- group: DICOM-DEV

trigger:
  branches:
    include:
    - master

pr: none

stages:
- stage: PublishContainer
  displayName: 'Publish Docker CI Container'
  jobs:
  - job: 'Docker'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: docker-build-push.yml
      parameters:
        tag: $(imageTag)

- stage: AKSDeploy
  displayName: Deploy to AKS
  jobs:
  - job: GetConnectionStrings
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: Get connection strings
      inputs:
        azureSubscription: $(azureSubscriptionName)
        scriptType: bash
        scriptLocation: inlineScript
        failOnStandardError: true
        inlineScript: |
          echo "##vso[task.setvariable variable=SqlConnectionString]Server=tcp:$(SQLServerName).database.windows.net,1433;Database=$(SQLDbName);User ID=$(SQLUsername);Password=$(SQLServerPassword);Encrypt=true;Connection Timeout=30;"
          echo "##vso[task.setvariable variable=BlobConnectionString]$(az storage account show-connection-string -g cd-dicom -n cddicom --query "connectionString" -o tsv)"
        
  - template: helm-deploy.yml
    parameters:
      environmentName: DICOM-DEV.dicom
      logicalEnvironment: DEV
      chartPath: 'helm/dicom-server'
      releaseName: 'dicom-server'
      overrideValues: 'image.tag=$(imageTag),secrets.sqlserver_connectionstring=$(SqlConnectionString),secrets.blob_connectionstring=$(BlobConnectionString)'
      valueFile: 'helm/dicom-server/values.yml'
